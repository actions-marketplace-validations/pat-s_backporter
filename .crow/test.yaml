variables:
  - &golang_image 'reg.devxy.io/docker.io/library/golang:1.25-alpine'
  - &when
    - path: &when_path # related config files
        - '.crow/test.yaml'
        - '.golangci.yaml'
        # go source code
        - '**/*.go'
        - 'go.*'
      event: pull_request

when:
  - event: pull_request
  - event: push
    branch: ${CI_REPO_DEFAULT_BRANCH}
    path: *when_path

steps:
  vendor:
    image: *golang_image
    commands:
      - go mod vendor
    when:
      path:
        - <<: *when_path
        - '.crow/**'

  lint:
    depends_on:
      - vendor
    image: *golang_image
    commands:
      - apk add --no-cache -q just git sqlite-dev libc-dev gcc g++ build-base musl-dev binutils binutils-gold
      # using this instead of apk as it is always using the most recent go version - otherwise golangci-lint complains about a mismatch when a new go version is released
      - wget -O- -nv https://raw.githubusercontent.com/golangci/golangci-lint/HEAD/install.sh | sh -s && mv ./bin/golangci-lint /usr/local/bin/
      - golangci-lint run
    when: *when

  test:
    depends_on:
      - vendor
    image: *golang_image
    commands:
      - apk add --no-cache -q just git gcc musl-dev
      - just test
    when:
      - path: *when_path
