when:
  - event: tag

depends_on:
  - release

steps:
  'Push to GitHub mirror':
    image: reg.devxy.io/docker.io/appleboy/drone-git-push:1.1.1
    settings:
      remote: ssh://git@github.com/pat-s/backporter.git
      branch: main
      force: true
      followtags: true
      ssh_key:
        from_secret: homebrew-tap-deploy-key

  changelog:
    image: reg.devxy.io/docker.io/thegeeklab/git-sv:2.0.9
    commands:
      - apk add --no-cache -q sed
      - git sv release-notes -t ${CI_COMMIT_TAG} -o CHANGELOG.md
      - sed -i '1,2d' CHANGELOG.md

  'Create GitHub release':
    image: reg.devxy.io/docker.io/library/alpine:3.23
    environment:
      GITHUB_TOKEN:
        from_secret: github_release_token
    commands:
      - apk add --no-cache -q github-cli
      - gh release delete ${CI_COMMIT_TAG} --repo pat-s/backporter --yes || true
      - gh release create ${CI_COMMIT_TAG} --repo pat-s/backporter --title "${CI_COMMIT_TAG}" --notes-file CHANGELOG.md
