variables:
  - &buildx_plugin 'codeberg.org/crow-plugins/docker-buildx:2.0.1'
  - &platforms_pr 'linux/amd64'
  - &platforms_release 'linux/arm64,linux/amd64'
  - &build_args 'CI_COMMIT_SHA=${CI_COMMIT_SHA},CI_COMMIT_TAG=${CI_COMMIT_TAG}'

  - publish_logins: &publish_logins
      - registry: https://codefloe.com
        username: pat-s
        password:
          from_secret: codefloe_packages_token
  - &publish_repo 'codefloe.com/pat-s/backporter'
  - path:
      # web source code
      &when_path # go source code
      - '**/*.go'
      - 'go.*'
      # Containerfile changes
      - 'images/**'
      # pipeline config changes
      - '.crow/image.yaml'

when:
  - event: [pull_request, deployment, tag]

steps:
  pr-build:
    image: *buildx_plugin
    settings:
      dry_run: true
      repo: *publish_repo
      dockerfile: images/Containerfile.alpine
      platforms: *platforms_pr
      tag: pull_${CI_COMMIT_PULL_REQUEST}
    when:
      - evaluate: 'not (CI_COMMIT_PULL_REQUEST_LABELS contains "build_pr_images")'
        event: pull_request
        path: *when_path

  release-build:
    image: *buildx_plugin
    settings:
      repo: *publish_repo
      dockerfile: images/Containerfile.alpine
      platforms: *platforms_release
      tag: ['${CI_COMMIT_TAG%%.*}', '${CI_COMMIT_TAG%.*}', '${CI_COMMIT_TAG}']
      logins: *publish_logins
      build_args: *build_args
    when:
      event: tag
