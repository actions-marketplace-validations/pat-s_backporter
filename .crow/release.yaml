when:
  - event: tag

variables:
  - &golang_image 'reg.devxy.io/docker.io/library/golang:1.25-alpine3.23'

clone:
  git:
    image: codeberg.org/crow-plugins/clone:1.0.2
    settings:
      tags: true

steps:
  vendor:
    image: *golang_image
    commands:
      - go mod vendor
      - go mod tidy

  build-cli:
    image: *golang_image
    commands:
      - apk add --no-cache -q just git
      - just build-all

  changelog:
    image: reg.devxy.io/docker.io/thegeeklab/git-sv:2.0.9
    commands:
      - apk add --no-cache -q sed
      - git sv current-version
      - git sv release-notes -t ${CI_COMMIT_TAG} -o CHANGELOG.md
      - sed -i '1,2d' CHANGELOG.md #  remove version
      - cat CHANGELOG.md

  # the dynamic release source tarball changes it checksum frequently
  source-tarball:
    image: reg.devxy.io/docker.io/library/alpine:3.23
    commands:
      - apk add --no-cache -q git
      - git archive --format=tar.gz --prefix=backporter-${CI_COMMIT_TAG#v}/ -o dist/backporter-${CI_COMMIT_TAG#v}.tar.gz HEAD

  'Create release':
    image: reg.devxy.io/docker.io/woodpeckerci/plugin-release:0.2.6
    settings:
      note: CHANGELOG.md
      api_key:
        from_secret: codefloe_issue_token
      files:
        - dist/*.tar.gz
      title: ${CI_COMMIT_TAG}

  'Bump version in homebrew-tap':
    image: reg.devxy.io/docker.io/library/alpine:3.23
    commands:
      - apk add --no-cache -q curl git sed
      - git clone ${CI_FORGE_URL}/${CI_REPO_OWNER}/homebrew-tap.git
      - cd homebrew-tap
      - BASE_URL="${CI_FORGE_URL}/${CI_REPO}/releases/download/${CI_COMMIT_TAG}"
      - VERSION="${CI_COMMIT_TAG#v}"
      # Download all binaries and compute checksums
      - SHA_DARWIN_ARM64=$$(curl -sL "$${BASE_URL}/backporter_darwin_arm64.tar.gz" | sha256sum | cut -d' ' -f1)
      - SHA_DARWIN_AMD64=$$(curl -sL "$${BASE_URL}/backporter_darwin_amd64.tar.gz" | sha256sum | cut -d' ' -f1)
      - SHA_LINUX_ARM64=$$(curl -sL "$${BASE_URL}/backporter_linux_arm64.tar.gz" | sha256sum | cut -d' ' -f1)
      - SHA_LINUX_AMD64=$$(curl -sL "$${BASE_URL}/backporter_linux_amd64.tar.gz" | sha256sum | cut -d' ' -f1)
      # Update version
      - sed -i "s/version \"[^\"]*\"/version \"$${VERSION}\"/" Formula/backporter.rb
      # Update URLs
      - sed -i "s|url \".*backporter_darwin_arm64.tar.gz\"|url \"$${BASE_URL}/backporter_darwin_arm64.tar.gz\"|" Formula/backporter.rb
      - sed -i "s|url \".*backporter_darwin_amd64.tar.gz\"|url \"$${BASE_URL}/backporter_darwin_amd64.tar.gz\"|" Formula/backporter.rb
      - sed -i "s|url \".*backporter_linux_arm64.tar.gz\"|url \"$${BASE_URL}/backporter_linux_arm64.tar.gz\"|" Formula/backporter.rb
      - sed -i "s|url \".*backporter_linux_amd64.tar.gz\"|url \"$${BASE_URL}/backporter_linux_amd64.tar.gz\"|" Formula/backporter.rb
      # Update checksums (match by URL context on previous line)
      - sed -i "/darwin_arm64/{n;s/sha256 \"[^\"]*\"/sha256 \"$${SHA_DARWIN_ARM64}\"/;}" Formula/backporter.rb
      - sed -i "/darwin_amd64/{n;s/sha256 \"[^\"]*\"/sha256 \"$${SHA_DARWIN_AMD64}\"/;}" Formula/backporter.rb
      - sed -i "/linux_arm64/{n;s/sha256 \"[^\"]*\"/sha256 \"$${SHA_LINUX_ARM64}\"/;}" Formula/backporter.rb
      - sed -i "/linux_amd64/{n;s/sha256 \"[^\"]*\"/sha256 \"$${SHA_LINUX_AMD64}\"/;}" Formula/backporter.rb

  'Push changes to homebrew-tap':
    image: reg.devxy.io/docker.io/appleboy/drone-git-push:1.1.1
    settings:
      path: homebrew-tap
      remote: ssh://git@${CI_FORGE_URL#https://}/${CI_REPO_OWNER}/homebrew-tap.git
      branch: main
      commit: true
      ssh_key:
        from_secret: homebrew-tap-deploy-key
      commit_message: 'chore: bump version to ${CI_COMMIT_TAG}'
      commit_author: pat-s
      commit_author_email: pat-s@mailbox.org
