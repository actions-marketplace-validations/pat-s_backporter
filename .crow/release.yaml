when:
  - event: tag

variables:
  - &golang_image 'reg.devxy.io/docker.io/library/golang:1.25-alpine'

clone:
  git:
    image: codeberg.org/crow-plugins/clone:1.0.2
    settings:
      tags: true

steps:
  vendor:
    image: *golang_image
    commands:
      - go mod vendor

  build-cli:
    image: *golang_image
    commands:
      - apk add --no-cache -q just git sqlite-dev libc-dev gcc g++ build-base musl-dev binutils binutils-gold zip
      - just release-cli

  changelog:
    image: reg.devxy.io/docker.io/thegeeklab/git-sv:2.0.9
    commands:
      - apk add --no-cache -q sed
      - git sv current-version
      - git sv release-notes -t ${CI_COMMIT_TAG} -o CHANGELOG.md
      - sed -i '1,2d' CHANGELOG.md #  remove version
      - cat CHANGELOG.md

  'Create release':
    image: reg.devxy.io/docker.io/woodpeckerci/plugin-release:0.2.6
    settings:
      note: CHANGELOG.md
      api_key:
        from_secret: codefloe_issue_token
      files:
        - dist/*.tar.gz
      title: ${CI_COMMIT_TAG}

  'Bump version in homebrew-tap':
    image: alpine:3.23
    commands:
      - apk add --no-cache -q curl jq git sed
      - git clone https://${CI_FORGE_URL}/${CI_REPO_OWNER}/homebrew-tap.git
      - cd homebrew-tap
      - curl -s -O "https://${CI_FORGE_URL}/${CI_REPO}/archive/refs/tags/${CI_COMMIT_TAG}.tar.gz"
      - SHA256=$(sha256sum "${CI_COMMIT_TAG}.tar.gz" | cut -d' ' -f1)
      - sed -i "s|url .*\.tar\.gz|url \"https://${CI_FORGE_URL}/${CI_REPO}/archive/refs/tags/${CI_COMMIT_TAG}.tar.gz|" Formula/backporter.rb
      - sed -i "s/sha256 \"[^\"]*\"/sha256 \"$SHA256\"/" Formula/backporter.rb
      - rm -rf ${CI_COMMIT_TAG}.tar.gz

  'Push changes to homebrew-tap':
    image: reg.devxy.io/docker.io/appleboy/drone-git-push:1.1.1
    settings:
      path: homebrew-tap
      remote: ssh://git@${CI_FORGE_URL}/${CI_REPO_OWNER}/homebrew-tap.git
      branch: main
      commit: true
      ssh_key:
        from_secret: crowci-bot-ssh-key
      commit_message: 'chore: bump version to ${CI_COMMIT_TAG}'
      commit_author: pat-s
      commit_author_email: pat-s@mailbox.org
