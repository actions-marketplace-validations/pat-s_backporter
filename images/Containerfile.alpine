FROM --platform=$BUILDPLATFORM golang:1.23-alpine AS build

WORKDIR /src
COPY . .
ARG DOCKER_IMAGE_CREATED="unknown"
ARG TARGETOS TARGETARCH CI_COMMIT_SHA CI_COMMIT_TAG VERSION
ENV GOOS=$TARGETOS
ENV GOARCH=$TARGETARCH
RUN apk add --no-cache -q git

# Build with version injection.
RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg \
    CGO_ENABLED=0 go build -ldflags "-s -w -extldflags '-static' -X codefloe.com/pat-s/backporter/shared/version.Version=${VERSION:-dev}" -o /backporter ./cmd/backporter

FROM alpine:3.20

LABEL org.label-schema.license="MIT" \
      org.label-schema.vcs-url="https://codefloe.com/pat-s/backporter" \
      org.label-schema.vendor="pat-s" \
      org.opencontainers.image.created="${DOCKER_IMAGE_CREATED}" \
      org.opencontainers.image.description="Git backporter CLI (Alpine)" \
      maintainer="pat-s"

WORKDIR /workspace

# Install git (required for cherry-pick operations).
RUN apk add -U --no-cache ca-certificates git && \
  adduser -u 1000 -g 1000 -D backporter

ENV GODEBUG=netdns=go

COPY --from=build /backporter /usr/local/bin/

USER backporter

ENTRYPOINT ["/usr/local/bin/backporter"]
